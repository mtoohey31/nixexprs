From a603b1b5f52adfbfc34aef82a3806d7863775ea8 Mon Sep 17 00:00:00 2001
From: Matthew Toohey <contact@mtoohey.com>
Date: Thu, 17 Jul 2025 20:57:44 -0400
Subject: [PATCH 1/2] lean file progress gutter

---
 helix-lsp-types/src/file_progress.rs | 57 ++++++++++++++++++++++++++++
 helix-lsp-types/src/lib.rs           |  3 ++
 helix-lsp-types/src/notification.rs  | 13 +++++++
 helix-lsp/src/lib.rs                 |  5 +++
 helix-term/src/application.rs        | 15 ++++++++
 helix-view/src/document.rs           |  8 +++-
 helix-view/src/editor.rs             |  3 ++
 helix-view/src/gutter.rs             | 36 ++++++++++++++++++
 helix-view/src/handlers/lsp.rs       | 24 ++++++++++++
 9 files changed, 163 insertions(+), 1 deletion(-)
 create mode 100644 helix-lsp-types/src/file_progress.rs

diff --git a/helix-lsp-types/src/file_progress.rs b/helix-lsp-types/src/file_progress.rs
new file mode 100644
index 00000000..eb592788
--- /dev/null
+++ b/helix-lsp-types/src/file_progress.rs
@@ -0,0 +1,57 @@
+use serde::{Deserialize, Serialize};
+
+use crate::{OptionalVersionedTextDocumentIdentifier, Range};
+
+#[derive(Debug, PartialEq, Clone)]
+#[repr(u8)]
+pub enum FileProgressKind {
+    Processing = 1,
+    FatalError = 2,
+}
+
+impl<'de> Deserialize<'de> for FileProgressKind {
+    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error>
+    where
+        D: serde::Deserializer<'de>,
+    {
+        match <u8 as Deserialize>::deserialize(deserializer)? {
+            1 => Ok(FileProgressKind::Processing),
+            2 => Ok(FileProgressKind::FatalError),
+            other => Err(serde::de::Error::custom(format_args!(
+                "invalid value: {other}, expected 1 or 2"
+            ))),
+        }
+    }
+}
+
+impl Serialize for FileProgressKind {
+    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
+    where
+        S: serde::Serializer,
+    {
+        let value = match self {
+            FileProgressKind::Processing => 1,
+            FileProgressKind::FatalError => 2,
+        };
+        Serialize::serialize(&value, serializer)
+    }
+}
+
+#[derive(Debug, PartialEq, Deserialize, Serialize, Clone)]
+#[serde(rename_all = "camelCase")]
+pub struct FileProgressProcessingInfo {
+    pub range: Range,
+    pub kind: FileProgressKind,
+}
+
+/// The file progress notification is sent from the server to the client to
+/// inform it of how much of the file has been processed.
+#[derive(Debug, PartialEq, Deserialize, Serialize, Clone)]
+#[serde(rename_all = "camelCase")]
+pub struct FileProgressParams {
+    /// The document whose progress changed.
+    pub text_document: OptionalVersionedTextDocumentIdentifier,
+
+    /// The ranges of the file that are currently being processed by the server.
+    pub processing: Vec<FileProgressProcessingInfo>,
+}
diff --git a/helix-lsp-types/src/lib.rs b/helix-lsp-types/src/lib.rs
index fd668de5..c7e3259b 100644
--- a/helix-lsp-types/src/lib.rs
+++ b/helix-lsp-types/src/lib.rs
@@ -138,6 +138,9 @@ fn try_from(value: &str) -> Result<Self, Self::Error> {
 mod file_operations;
 pub use file_operations::*;
 
+mod file_progress;
+pub use file_progress::*;
+
 mod folding_range;
 pub use folding_range::*;
 
diff --git a/helix-lsp-types/src/notification.rs b/helix-lsp-types/src/notification.rs
index aef011d3..a5d8b9a6 100644
--- a/helix-lsp-types/src/notification.rs
+++ b/helix-lsp-types/src/notification.rs
@@ -70,6 +70,9 @@ macro_rules! lsp_notification {
     ("$/progress") => {
         $crate::notification::Progress
     };
+    ("$/lean/fileProgress") => {
+        $crate::notification::FileProgress
+    };
     ("workspace/didCreateFiles") => {
         $crate::notification::DidCreateFiles
     };
@@ -272,6 +275,16 @@ impl Notification for Progress {
     const METHOD: &'static str = "$/progress";
 }
 
+/// The file progress notification is sent from the server to the client to
+/// inform it of how much of the file has been processed.
+#[derive(Debug)]
+pub enum FileProgress {}
+
+impl Notification for FileProgress {
+    type Params = FileProgressParams;
+    const METHOD: &'static str = "$/lean/fileProgress";
+}
+
 /// The `window/workDoneProgress/cancel` notification is sent from the client
 /// to the server to cancel a progress initiated on the server side using the `window/workDoneProgress/create`.
 #[derive(Debug)]
diff --git a/helix-lsp/src/lib.rs b/helix-lsp/src/lib.rs
index f207cc5b..8b151eac 100644
--- a/helix-lsp/src/lib.rs
+++ b/helix-lsp/src/lib.rs
@@ -526,6 +526,7 @@ pub enum Notification {
     ShowMessage(lsp::ShowMessageParams),
     LogMessage(lsp::LogMessageParams),
     ProgressMessage(lsp::ProgressParams),
+    FileProgressMessage(lsp::FileProgressParams),
     // Other kind specifically for extensions
     Other(String, jsonrpc::Params),
 }
@@ -554,6 +555,10 @@ pub fn parse(method: &str, params: jsonrpc::Params) -> Result<Notification> {
                 let params: lsp::ProgressParams = params.parse()?;
                 Self::ProgressMessage(params)
             }
+            lsp::notification::FileProgress::METHOD => {
+                let params: lsp::FileProgressParams = params.parse()?;
+                Self::FileProgressMessage(params)
+            }
             _ => Self::Other(method.to_owned(), params),
         };
 
diff --git a/helix-term/src/application.rs b/helix-term/src/application.rs
index 212e860c..c048b514 100644
--- a/helix-term/src/application.rs
+++ b/helix-term/src/application.rs
@@ -978,6 +978,21 @@ macro_rules! language_server {
                     Notification::ProgressMessage(_params) => {
                         // do nothing
                     }
+                    Notification::FileProgressMessage(params) => {
+                        let uri = match helix_core::Uri::try_from(params.text_document.uri) {
+                            Ok(uri) => uri,
+                            Err(err) => {
+                                log::error!("{err}");
+                                return;
+                            }
+                        };
+
+                        self.editor.handle_file_progress(
+                            uri,
+                            params.text_document.version,
+                            params.processing,
+                        );
+                    }
                     Notification::Exit => {
                         self.editor.set_status("Language server exited");
 
diff --git a/helix-view/src/document.rs b/helix-view/src/document.rs
index d0bb48ed..f51715a9 100644
--- a/helix-view/src/document.rs
+++ b/helix-view/src/document.rs
@@ -13,7 +13,7 @@
 use helix_core::syntax::config::LanguageServerFeature;
 use helix_core::text_annotations::{InlineAnnotation, Overlay};
 use helix_event::TaskController;
-use helix_lsp::util::lsp_pos_to_pos;
+use helix_lsp::{lsp::FileProgressProcessingInfo, util::lsp_pos_to_pos};
 use helix_stdx::faccess::{copy_metadata, readonly};
 use helix_vcs::{DiffHandle, DiffProviderRegistry};
 use once_cell::sync::OnceCell;
@@ -194,6 +194,8 @@ pub struct Document {
     pub(crate) modified_since_accessed: bool,
 
     pub(crate) diagnostics: Vec<Diagnostic>,
+    pub(crate) progress: Vec<FileProgressProcessingInfo>,
+    pub(crate) progress_received: bool,
     pub(crate) language_servers: HashMap<LanguageServerName, Arc<Client>>,
 
     diff_handle: Option<DiffHandle>,
@@ -321,6 +323,8 @@ fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
             .field("version", &self.version)
             .field("modified_since_accessed", &self.modified_since_accessed)
             .field("diagnostics", &self.diagnostics)
+            .field("progress", &self.progress)
+            .field("progress_received", &self.progress_received)
             // .field("language_server", &self.language_server)
             .finish()
     }
@@ -720,6 +724,8 @@ pub fn from(
             changes,
             old_state,
             diagnostics: Vec::new(),
+            progress: Vec::new(),
+            progress_received: false,
             version: 0,
             history: Cell::new(History::default()),
             savepoints: Vec::new(),
diff --git a/helix-view/src/editor.rs b/helix-view/src/editor.rs
index 47f0791e..b20d77d1 100644
--- a/helix-view/src/editor.rs
+++ b/helix-view/src/editor.rs
@@ -97,6 +97,7 @@ impl Default for GutterConfig {
     fn default() -> Self {
         Self {
             layout: vec![
+                GutterType::Progress,
                 GutterType::Diagnostics,
                 GutterType::Spacer,
                 GutterType::LineNumbers,
@@ -799,6 +800,8 @@ pub enum GutterType {
     Spacer,
     /// Highlight local changes
     Diff,
+    /// Show language server processing progress
+    Progress,
 }
 
 impl std::str::FromStr for GutterType {
diff --git a/helix-view/src/gutter.rs b/helix-view/src/gutter.rs
index 7506e515..3dea15be 100644
--- a/helix-view/src/gutter.rs
+++ b/helix-view/src/gutter.rs
@@ -1,6 +1,7 @@
 use std::fmt::Write;
 
 use helix_core::syntax::config::LanguageServerFeature;
+use helix_lsp::lsp::{FileProgressKind, FileProgressProcessingInfo};
 
 use crate::{
     editor::GutterType,
@@ -32,6 +33,7 @@ pub fn style<'doc>(
             GutterType::LineNumbers => line_numbers(editor, doc, view, theme, is_focused),
             GutterType::Spacer => padding(editor, doc, view, theme, is_focused),
             GutterType::Diff => diff(editor, doc, view, theme, is_focused),
+            GutterType::Progress => progress(editor, doc, view, theme, is_focused),
         }
     }
 
@@ -41,6 +43,7 @@ pub fn width(self, view: &View, doc: &Document) -> usize {
             GutterType::LineNumbers => line_numbers_width(view, doc),
             GutterType::Spacer => 1,
             GutterType::Diff => 1,
+            GutterType::Progress => doc.progress_received.into(),
         }
     }
 }
@@ -139,6 +142,39 @@ pub fn diff<'doc>(
     }
 }
 
+pub fn progress<'doc>(
+    _editor: &'doc Editor,
+    doc: &'doc Document,
+    _view: &View,
+    theme: &Theme,
+    _is_focused: bool,
+) -> GutterFn<'doc> {
+    let processing = theme.get("diff.delta.gutter");
+    let fatal_error = theme.get("diff.minus.gutter");
+
+    let progress = doc.progress.clone();
+    if progress.is_empty() {
+        return Box::new(move |_, _, _, _| None);
+    }
+
+    Box::new(
+        move |line: usize, _selected: bool, _first_visual_line: bool, out: &mut String| {
+            let Some(FileProgressProcessingInfo { kind, .. }) = progress.iter().find(|fppi| {
+                fppi.range.start.line as usize <= line && line < fppi.range.end.line as usize
+            }) else {
+                return None;
+            };
+
+            let style = match kind {
+                FileProgressKind::Processing => processing,
+                FileProgressKind::FatalError => fatal_error,
+            };
+            write!(out, "‚ñç").unwrap();
+            Some(style)
+        },
+    )
+}
+
 pub fn line_numbers<'doc>(
     editor: &'doc Editor,
     doc: &'doc Document,
diff --git a/helix-view/src/handlers/lsp.rs b/helix-view/src/handlers/lsp.rs
index 96ab4626..21cff986 100644
--- a/helix-view/src/handlers/lsp.rs
+++ b/helix-view/src/handlers/lsp.rs
@@ -379,6 +379,30 @@ pub fn handle_lsp_diagnostics(
         }
     }
 
+    pub fn handle_file_progress(
+        &mut self,
+        uri: Uri,
+        version: Option<i32>,
+        processing: Vec<lsp::FileProgressProcessingInfo>,
+    ) {
+        let doc = self
+            .documents
+            .values_mut()
+            .find(|doc| doc.uri().is_some_and(|u| u == uri));
+
+        if let Some((version, doc)) = version.zip(doc.as_ref()) {
+            if version != doc.version() {
+                log::info!("Version ({version}) is out of date for {uri:?} (expected ({})), dropping PublishDiagnostic notification", doc.version());
+                return;
+            }
+        }
+
+        if let Some(doc) = doc {
+            doc.progress = processing;
+            doc.progress_received = true;
+        }
+    }
+
     pub fn execute_lsp_command(&mut self, command: lsp::Command, server_id: LanguageServerId) {
         // the command is executed on the server and communicated back
         // to the client asynchronously using workspace edits
-- 
2.51.0

